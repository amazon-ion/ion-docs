%%%---------------------------------------------------------
%%% This file was generated at 2023-11-04T01:16:36.685-00:00
%%%---------------------------------------------------------
% tag::domains[]
% tag::B[]
\mbox{\bf B} ~\equiv~ \mbox{(Booleans)}
% end::B[]
\newline
% tag::I[]
\mbox{\bf I} ~\equiv~ \mbox{(Integers)}
% end::I[]
\newline
% tag::Unicode[]
\mbox{\bf Unicode} ~\equiv~ \mbox{(Sequences of Unicode code points)}
% end::Unicode[]
\newline
% tag::IVM[]
\mbox{\bf IVM} ~\equiv~ \mbox{\bf I} \times \mbox{\bf I}
% end::IVM[]
\newline
% tag::Sym0[]
\mbox{\bf Sym0} ~\equiv~ \mbox{(The undefined symbol)}
% end::Sym0[]
\newline
% tag::DotNull[]
\mbox{\bf DotNull} ~\equiv~ \mbox{(Sentinel for typed nulls)}
% end::DotNull[]
\newline
% tag::NullNull[]
\mbox{\bf NullNull} ~\equiv~ \mbox{\bf DotNull}
% end::NullNull[]
\newline
% tag::Bool[]
\mbox{\bf Bool} ~\equiv~ \mbox{\bf B} + \mbox{\bf DotNull}
% end::Bool[]
\newline
% tag::Int[]
\mbox{\bf Int} ~\equiv~ \mbox{\bf I} + \mbox{\bf DotNull}
% end::Int[]
\newline
% tag::String[]
\mbox{\bf String} ~\equiv~ \mbox{\bf Unicode} + \mbox{\bf DotNull}
% end::String[]
\newline
% tag::SSymTok[]
\mbox{\bf SSymTok} ~\equiv~ \mbox{\bf Unicode} + \mbox{\bf I}
% end::SSymTok[]
\newline
% tag::SSymbol[]
\mbox{\bf SSymbol} ~\equiv~ \mbox{\bf SSymTok} + \mbox{\bf DotNull}
% end::SSymbol[]
\newline
% tag::SList[]
\mbox{\bf SList} ~\equiv~ \mbox{\bf STree*} + \mbox{\bf DotNull}
% end::SList[]
\newline
% tag::SSexp[]
\mbox{\bf SSexp} ~\equiv~ \mbox{\bf STree*} + \mbox{\bf DotNull}
% end::SSexp[]
\newline
% tag::SField[]
\mbox{\bf SField} ~\equiv~ \mbox{\bf SSymTok} \times \mbox{\bf STree}
% end::SField[]
\newline
% tag::SStruct[]
\mbox{\bf SStruct} ~\equiv~ \mbox{\bf SField*} + \mbox{\bf DotNull}
% end::SStruct[]
\newline
% tag::SContent[]
\mbox{\bf SContent} ~\equiv~ \mbox{\bf SSymbol} + \mbox{\bf SList} + \mbox{\bf SSexp} + \mbox{\bf SStruct} + \mbox{\bf NullNull} + \mbox{\bf Bool} + \mbox{\bf Int} + \mbox{\bf String}
% end::SContent[]
\newline
% tag::SValue[]
\mbox{\bf SValue} ~\equiv~ \mbox{\bf SSymTok*} \times \mbox{\bf SContent}
% end::SValue[]
\newline
% tag::STree[]
\mbox{\bf STree} ~\equiv~ \mbox{\bf SValue}
% end::STree[]
\newline
% tag::TSTree[]
\mbox{\bf TSTree} ~\equiv~ \mbox{\bf STree} + \mbox{\bf IVM}
% end::TSTree[]
\newline
% tag::SymTok[]
\mbox{\bf SymTok} ~\equiv~ \mbox{\bf Unicode} + \mbox{\bf Sym0}
% end::SymTok[]
\newline
% tag::Symbol[]
\mbox{\bf Symbol} ~\equiv~ \mbox{\bf SymTok} + \mbox{\bf DotNull}
% end::Symbol[]
\newline
% tag::List[]
\mbox{\bf List} ~\equiv~ \mbox{\bf Value*} + \mbox{\bf DotNull}
% end::List[]
\newline
% tag::Sexp[]
\mbox{\bf Sexp} ~\equiv~ \mbox{\bf Value*} + \mbox{\bf DotNull}
% end::Sexp[]
\newline
% tag::Field[]
\mbox{\bf Field} ~\equiv~ \mbox{\bf SymTok} \times \mbox{\bf Value}
% end::Field[]
\newline
% tag::Struct[]
\mbox{\bf Struct} ~\equiv~ \mbox{\bf Field*} + \mbox{\bf DotNull}
% end::Struct[]
\newline
% tag::Content[]
\mbox{\bf Content} ~\equiv~ \mbox{\bf Symbol} + \mbox{\bf List} + \mbox{\bf Sexp} + \mbox{\bf Struct} + \mbox{\bf NullNull} + \mbox{\bf Bool} + \mbox{\bf Int} + \mbox{\bf String}
% end::Content[]
\newline
% tag::Value[]
\mbox{\bf Value} ~\equiv~ \mbox{\bf SymTok*} \times \mbox{\bf Content}
% end::Value[]
\newline
% tag::SharedSymtab[]
\mbox{\bf SharedSymtab} ~\equiv~ \mbox{\bf Unicode} \times \mbox{\bf I} \times \mbox{\bf SymTok*}
% end::SharedSymtab[]
\newline
% tag::Catalog[]
\mbox{\bf Catalog} ~\equiv~ \mbox{\bf SharedSymtab*}
% end::Catalog[]
\newline
% tag::Environment[]
\mbox{\bf Environment} ~\equiv~ \mbox{\bf Catalog} \times \mbox{\bf IVM} \times \mbox{\bf SymTok*}
% end::Environment[]
\newline
% tag::TContinuation[]
\mbox{\bf TContinuation} ~\equiv~ \mbox{\bf Environment} \times \mbox{\bf Value*} \rightarrow \mbox{\bf Value*}
% end::TContinuation[]
\newline
% tag::ParseStep[]
\mbox{\bf ParseStep} ~\equiv~ \mbox{\bf TSTree} \times \mbox{\bf ParseStream}
% end::ParseStep[]
\newline
% tag::ParseStream[]
\mbox{\bf ParseStream} ~\equiv~ \mbox{\bf IVM} \rightarrow \mbox{\bf ParseStep?}
% end::ParseStream[]
\newline
% tag::Document[]
\mbox{\bf Document} ~\equiv~ \mbox{(Ion documents)}
% end::Document[]
\newline
% tag::Parser[]
\mbox{\bf Parser} ~\equiv~ \mbox{\bf Document} \rightarrow \mbox{\bf ParseStream}
% end::Parser[]
\newline
% tag::Evaluator[]
\mbox{\bf Evaluator} ~\equiv~ \mbox{\bf Document} \times \mbox{\bf Catalog} \rightarrow \mbox{\bf Value*}
% end::Evaluator[]
\newline
% end::domains[]
% tag::functions[]
\newline
% tag::IVM_eq[]
\mbox{\it i\/}_{1} = \mbox{\it i\/}_{2} ~\equiv~ \mbox{\it i\/}_{1}\!\downarrow_{0} = \mbox{\it i\/}_{2}\!\downarrow_{0}\ \wedge\ \mbox{\it i\/}_{1}\!\downarrow_{1} = \mbox{\it i\/}_{2}\!\downarrow_{1}$\`$ \mbox{\bf IVM} \times \mbox{\bf IVM} \rightarrow \mbox{\bf B}
% end::IVM_eq[]
\newline
\newline
% tag::SValue_annots[]
\mbox{\it sv\/}\!\downarrow_{\mbox{\scriptsize annots}} ~\equiv~ \mbox{\it sv\/}\!\downarrow_{0}$\`$ \mbox{\bf SValue} \rightarrow \mbox{\bf SSymTok*}
% end::SValue_annots[]
\newline
\newline
% tag::SValue_content[]
\mbox{\it sv\/}\!\downarrow_{\mbox{\scriptsize content}} ~\equiv~ \mbox{\it sv\/}\!\downarrow_{1}$\`$ \mbox{\bf SValue} \rightarrow \mbox{\bf SContent}
% end::SValue_content[]
\newline
\newline
% tag::SField_name[]
\mbox{\it sf\/}\!\downarrow_{\mbox{\scriptsize name}} ~\equiv~ \mbox{\it sf\/}\!\downarrow_{0}$\`$ \mbox{\bf SField} \rightarrow \mbox{\bf SSymTok}
% end::SField_name[]
\newline
\newline
% tag::SField_tree[]
\mbox{\it sf\/}\!\downarrow_{\mbox{\scriptsize tree}} ~\equiv~ \mbox{\it sf\/}\!\downarrow_{1}$\`$ \mbox{\bf SField} \rightarrow \mbox{\bf STree}
% end::SField_tree[]
\newline
\newline
% tag::Value_annots[]
\mbox{\it v\/}\!\downarrow_{\mbox{\scriptsize annots}} ~\equiv~ \mbox{\it v\/}\!\downarrow_{0}$\`$ \mbox{\bf Value} \rightarrow \mbox{\bf SymTok*}
% end::Value_annots[]
\newline
\newline
% tag::Value_content[]
\mbox{\it v\/}\!\downarrow_{\mbox{\scriptsize content}} ~\equiv~ \mbox{\it v\/}\!\downarrow_{1}$\`$ \mbox{\bf Value} \rightarrow \mbox{\bf Content}
% end::Value_content[]
\newline
\newline
% tag::Field_name[]
\mbox{\it f\/}\!\downarrow_{\mbox{\scriptsize name}} ~\equiv~ \mbox{\it f\/}\!\downarrow_{0}$\`$ \mbox{\bf Field} \rightarrow \mbox{\bf SymTok}
% end::Field_name[]
\newline
\newline
% tag::Field_value[]
\mbox{\it f\/}\!\downarrow_{\mbox{\scriptsize value}} ~\equiv~ \mbox{\it f\/}\!\downarrow_{1}$\`$ \mbox{\bf Field} \rightarrow \mbox{\bf Value}
% end::Field_value[]
\newline
\newline
% tag::SymTok_matches[]
\mbox{\it s\/} \cong \mbox{\it u\/} ~\equiv~ \mbox{\it s\/}\in \mbox{\bf Unicode}\ \wedge\ \mbox{\it s\/}\mid_{\mbox{\scriptsize $\mbox{\bf Unicode}$}} = \mbox{\it u\/}$\`$ \mbox{\bf SymTok} \times \mbox{\bf Unicode} \rightarrow \mbox{\bf B}
% end::SymTok_matches[]
\newline
\newline
% tag::Symbol_matches[]
\mbox{\it s\/} \cong \mbox{\it u\/} ~\equiv~ \mbox{\it s\/}\in \mbox{\bf SymTok}\ \wedge\ \mbox{\it s\/}\mid_{\mbox{\scriptsize $\mbox{\bf SymTok}$}} \cong \mbox{\it u\/}$\`$ \mbox{\bf Symbol} \times \mbox{\bf Unicode} \rightarrow \mbox{\bf B}
% end::Symbol_matches[]
\newline
\newline
% tag::Value_is_symbol_matching[]
\mbox{\it v\/} \cong \mbox{\it u\/} ~\equiv~ \mbox{\it v\/}\!\downarrow_{\mbox{\scriptsize content}}\in \mbox{\bf Symbol}\ \wedge\ \mbox{\it v\/}\!\downarrow_{\mbox{\scriptsize content}}\mid_{\mbox{\scriptsize $\mbox{\bf Symbol}$}} \cong \mbox{\it u\/}$\`$ \mbox{\bf Value} \times \mbox{\bf Unicode} \rightarrow \mbox{\bf B}
% end::Value_is_symbol_matching[]
\newline
\newline
% tag::Fields_get[]
\mbox{\it f\/}^{\ast} \odot^{\ast} \mbox{\it u\/} ~\equiv~ $\`$ \mbox{\bf Field*} \times \mbox{\bf Unicode} \rightarrow \mbox{\bf Value*}\newline
\:\: \setandincrindent
 \setandincrindent
\:\mbox{\bf{if}}\:\#\mbox{\it f\/}^{\ast}=0\newline
\:\mbox{\bf{then}}\:\langle \rangle \newline
\:\mbox{\bf{else}}\: \setandincrindent
\:\mbox{\bf{let}}\:\mbox{\it f\/} = \mbox{\it f\/}^{\ast}\!\downarrow_{0}\newline
\:\mbox{\bf{and}}\:\mbox{\it v\/}^{\ast} = \mbox{\it f\/}^{\ast}\dagger1 \odot^{\ast} \mbox{\it u\/}\newline
\:\mbox{\bf{in}}\: \setandincrindent
\:\mbox{\bf{if}}\:\mbox{\it f\/}\!\downarrow_{\mbox{\scriptsize name}} \cong \mbox{\it u\/}\newline
\:\mbox{\bf{then}}\:\langle \mbox{\it f\/}\!\downarrow_{\mbox{\scriptsize value}}\rangle \S\mbox{\it v\/}^{\ast}\newline
\:\mbox{\bf{else}}\:\mbox{\it v\/}^{\ast}\newline
\:\mbox{\bf{endif}}\: \decrindent
 \decrindent
\newline
\:\mbox{\bf{endif}}\: \decrindent
 \decrindent
% end::Fields_get[]
\newline
\newline
% tag::Struct_get[]
\mbox{\it s\/} \odot^{\ast} \mbox{\it u\/} ~\equiv~ \mbox{\it s\/}\mid_{\mbox{\scriptsize $\mbox{\bf Field*}$}} \odot^{\ast} \mbox{\it u\/}$\`$ \mbox{\bf Struct} \times \mbox{\bf Unicode} \rightarrow \mbox{\bf Value*}
% end::Struct_get[]
\newline
\newline
% tag::Struct_get1[]
\mbox{\it s\/} \odot \mbox{\it u\/} ~\equiv~ $\`$ \mbox{\bf Struct} \times \mbox{\bf Unicode} \rightarrow \mbox{\bf Value?}\newline
\:\: \setandincrindent
 \setandincrindent
\:\mbox{\bf{let}}\:\mbox{\it v\/}^{\ast} = \mbox{\it s\/} \odot^{\ast} \mbox{\it u\/}\newline
\:\mbox{\bf{in}}\: \setandincrindent
\:\mbox{\bf{if}}\:\#\mbox{\it v\/}^{\ast} = 0\newline
\:\mbox{\bf{then}}\:\langle \rangle \newline
\:\mbox{\bf{else}}\: \setandincrindent
\:\mbox{\bf{if}}\:\#\mbox{\it v\/}^{\ast} = 1\newline
\:\mbox{\bf{then}}\:\langle \mbox{\it v\/}^{\ast}\!\downarrow_{0}\rangle \newline
\:\mbox{\bf{else}}\:\mbox{\it wrong\/}(\mbox{\rm ``{\tt Repeated field: }''}, \mbox{\it u\/})\newline
\:\mbox{\bf{endif}}\: \decrindent
\newline
\:\mbox{\bf{endif}}\: \decrindent
 \decrindent
 \decrindent
% end::Struct_get1[]
\newline
\newline
% tag::SymToks_for_IVM[]
\mbox{\it SymToks\_for\_IVM\/}(\mbox{\it i\/}) ~\equiv~ $\`$ \mbox{\bf IVM} \rightarrow \mbox{\bf SymTok*}\newline
\:\: \setandincrindent
 \setandincrindent
\:\mbox{\bf{if}}\:\mbox{\it i\/} = \mbox{\it IVM\_1\_0\/}\newline
\:\mbox{\bf{then}}\:\langle \mbox{\it{in}\small $\mbox{\bf SymTok}$}(\mbox{\it SYM0\/}), \mbox{\it{in}\small $\mbox{\bf SymTok}$}(\mbox{\it{in}\small $\mbox{\bf Unicode}$}(\mbox{\rm ``{\tt \$ion}''})), \mbox{\it{in}\small $\mbox{\bf SymTok}$}(\mbox{\it{in}\small $\mbox{\bf Unicode}$}(\mbox{\rm ``{\tt \$ion\_1\_0}''})), \mbox{\it{in}\small $\mbox{\bf SymTok}$}(\mbox{\it{in}\small $\mbox{\bf Unicode}$}(\mbox{\rm ``{\tt \$ion\_symbol\_table}''})), \mbox{\it{in}\small $\mbox{\bf SymTok}$}(\mbox{\it{in}\small $\mbox{\bf Unicode}$}(\mbox{\rm ``{\tt name}''})), \mbox{\it{in}\small $\mbox{\bf SymTok}$}(\mbox{\it{in}\small $\mbox{\bf Unicode}$}(\mbox{\rm ``{\tt version}''})), \mbox{\it{in}\small $\mbox{\bf SymTok}$}(\mbox{\it{in}\small $\mbox{\bf Unicode}$}(\mbox{\rm ``{\tt imports}''})), \mbox{\it{in}\small $\mbox{\bf SymTok}$}(\mbox{\it{in}\small $\mbox{\bf Unicode}$}(\mbox{\rm ``{\tt symbols}''})), \mbox{\it{in}\small $\mbox{\bf SymTok}$}(\mbox{\it{in}\small $\mbox{\bf Unicode}$}(\mbox{\rm ``{\tt max\_id}''})), \mbox{\it{in}\small $\mbox{\bf SymTok}$}(\mbox{\it{in}\small $\mbox{\bf Unicode}$}(\mbox{\rm ``{\tt \$ion\_shared\_symbol\_table}''}))\rangle \newline
\:\mbox{\bf{else}}\:\mbox{\it wrong\/}(\mbox{\rm ``{\tt Unsupported Ion version: }''}, \mbox{\it i\/}\!\downarrow_{0}, \mbox{\rm ``{\tt .}''}, \mbox{\it i\/}\!\downarrow_{1})\newline
\:\mbox{\bf{endif}}\: \decrindent
 \decrindent
% end::SymToks_for_IVM[]
\newline
\newline
% tag::SST_name[]
\mbox{\it s\/}\!\downarrow_{\mbox{\scriptsize name}} ~\equiv~ \mbox{\it s\/}\!\downarrow_{0}$\`$ \mbox{\bf SharedSymtab} \rightarrow \mbox{\bf Unicode}
% end::SST_name[]
\newline
\newline
% tag::SST_version[]
\mbox{\it s\/}\!\downarrow_{\mbox{\scriptsize version}} ~\equiv~ \mbox{\it s\/}\!\downarrow_{1}$\`$ \mbox{\bf SharedSymtab} \rightarrow \mbox{\bf I}
% end::SST_version[]
\newline
\newline
% tag::SST_symbols[]
\mbox{\it s\/}\!\downarrow_{\mbox{\scriptsize symbols}} ~\equiv~ \mbox{\it s\/}\!\downarrow_{2}$\`$ \mbox{\bf SharedSymtab} \rightarrow \mbox{\bf SymTok*}
% end::SST_symbols[]
\newline
\newline
% tag::is_SST[]
\mbox{\it is\_SST\/}(\mbox{\it v\/}) ~\equiv~ $\`$ \mbox{\bf Value} \rightarrow \mbox{\bf B}\newline
\:\: \setandincrindent
\mbox{\it v\/}\!\downarrow_{\mbox{\scriptsize content}}\in \mbox{\bf Struct}\ \wedge\ \#\mbox{\it v\/}\!\downarrow_{\mbox{\scriptsize annots}}\neq 0\ \wedge\ \mbox{\it v\/}\!\downarrow_{\mbox{\scriptsize annots}}\!\downarrow_{0} \cong \mbox{\rm ``{\tt \$ion\_shared\_symbol\_table}''} \decrindent
% end::is_SST[]
\newline
\newline
% tag::compile_SST[]
\mbox{\it compile\_SST\/}(\mbox{\it s\/}) ~\equiv~ $\`$ \mbox{\bf Struct} \rightarrow \mbox{\bf SharedSymtab}\newline
\:\: \setandincrindent
 \setandincrindent
\:\mbox{\bf{let}}\:\mbox{\it n\/} = \mbox{\it s\/} \odot \mbox{\rm ``{\tt name}''}\mbox{!}\!\downarrow_{\mbox{\scriptsize content}}\mid_{\mbox{\scriptsize $\mbox{\bf String}$}}\mid_{\mbox{\scriptsize $\mbox{\bf Unicode}$}}\newline
\:\mbox{\bf{and}}\:\mbox{\it v\/} = {\cal N}_{\mbox{\scriptsize\tt version}}(\mbox{\it s\/} \odot \mbox{\rm ``{\tt version}''})\newline
\:\mbox{\bf{in}}\:\mbox{\it{in}\small $\mbox{\bf SharedSymtab}$}(\langle \mbox{\it n\/}, \mbox{\it v\/}, {\cal C}_{\mbox{\scriptsize\tt symbols}}(\mbox{\it s\/} \odot \mbox{\rm ``{\tt symbols}''})\rangle ) \decrindent
 \decrindent
% end::compile_SST[]
\newline
\newline
% tag::best_match_Catalog[]
\mbox{\it best\_match}(\mbox{\it c\/}, \mbox{\it n\/}, \mbox{\it v\/}) ~\equiv~ $\`$ \mbox{\bf Catalog} \times \mbox{\bf Unicode} \times \mbox{\bf I} \rightarrow \mbox{\bf SharedSymtab?}\newline
\:\: \setandincrindent
\mbox{\it best\_match}(\mbox{\it c\/}\mid_{\mbox{\scriptsize $\mbox{\bf SharedSymtab*}$}}, \mbox{\it n\/}, \mbox{\it v\/}) \decrindent
% end::best_match_Catalog[]
\newline
\newline
% tag::best_match_SST[]
\mbox{\it best\_match}(\mbox{\it s\/}^{\ast}, \mbox{\it n\/}, \mbox{\it v\/}) ~\equiv~ $\`$ \mbox{\bf SharedSymtab*} \times \mbox{\bf Unicode} \times \mbox{\bf I} \rightarrow \mbox{\bf SharedSymtab?}\newline
\:\: \setandincrindent
 \setandincrindent
\:\mbox{\bf{if}}\:\#\mbox{\it s\/}^{\ast}=0\newline
\:\mbox{\bf{then}}\:\langle \rangle \newline
\:\mbox{\bf{else}}\: \setandincrindent
\:\mbox{\bf{let}}\:\mbox{\it s\/}_{0} = \mbox{\it s\/}^{\ast}\!\downarrow_{0}\newline
\:\mbox{\bf{and}}\:\mbox{\it s\/}^{\ast}_{1} = \mbox{\it best\_match}(\mbox{\it s\/}^{\ast}\dagger1, \mbox{\it n\/}, \mbox{\it v\/})\newline
\:\mbox{\bf{in}}\: \setandincrindent
\:\mbox{\bf{if}}\:\mbox{\it s\/}_{0}\!\downarrow_{\mbox{\scriptsize name}} \neq \mbox{\it n\/}\newline
\:\mbox{\bf{then}}\:\mbox{\it s\/}^{\ast}_{1}\newline
\:\mbox{\bf{else}}\: \setandincrindent
\:\mbox{\bf{if}}\:\mbox{\it s\/}_{0}\!\downarrow_{\mbox{\scriptsize version}} = \mbox{\it v\/}\ \vee\ \lnot \mbox{\it s\/}^{\ast}_{1}\mbox{\ooalign{?\cr\hss!\kern .025em\hss}}\newline
\:\mbox{\bf{then}}\:\langle \mbox{\it s\/}_{0}\rangle \newline
\:\mbox{\bf{else}}\: \setandincrindent
\:\mbox{\bf{if}}\:\mbox{\it s\/}^{\ast}_{1}\mbox{!}\!\downarrow_{\mbox{\scriptsize version}} = \mbox{\it v\/}\ \vee\ \mbox{\it s\/}^{\ast}_{1}\mbox{!}\!\downarrow_{\mbox{\scriptsize version}} > \mbox{\it s\/}_{0}\!\downarrow_{\mbox{\scriptsize version}}\newline
\:\mbox{\bf{then}}\:\mbox{\it s\/}^{\ast}_{1}\newline
\:\mbox{\bf{else}}\:\langle \mbox{\it s\/}_{0}\rangle \newline
\:\mbox{\bf{endif}}\: \decrindent
\newline
\:\mbox{\bf{endif}}\: \decrindent
\newline
\:\mbox{\bf{endif}}\: \decrindent
 \decrindent
\newline
\:\mbox{\bf{endif}}\: \decrindent
 \decrindent
% end::best_match_SST[]
\newline
\newline
% tag::Catalog_extend[]
\mbox{\it Catalog\_extend\/}(\mbox{\it c\/}, \mbox{\it s\/}) ~\equiv~ $\`$ \mbox{\bf Catalog} \times \mbox{\bf SharedSymtab} \rightarrow \mbox{\bf Catalog}\newline
\:\: \setandincrindent
\mbox{\it{in}\small $\mbox{\bf Catalog}$}(\langle \mbox{\it s\/}\rangle \S\mbox{\it c\/}\mid_{\mbox{\scriptsize $\mbox{\bf SharedSymtab*}$}}) \decrindent
% end::Catalog_extend[]
\newline
\newline
% tag::Environment_catalog[]
\rho\!\downarrow_{\mbox{\scriptsize catalog}} ~\equiv~ \rho\!\downarrow_{0}$\`$ \mbox{\bf Environment} \rightarrow \mbox{\bf Catalog}
% end::Environment_catalog[]
\newline
\newline
% tag::Environment_IVM[]
\rho\!\downarrow_{\mbox{\scriptsize IVM}} ~\equiv~ \rho\!\downarrow_{1}$\`$ \mbox{\bf Environment} \rightarrow \mbox{\bf IVM}
% end::Environment_IVM[]
\newline
\newline
% tag::Environment_symbols[]
\rho\!\downarrow_{\mbox{\scriptsize symbols}} ~\equiv~ \rho\!\downarrow_{2}$\`$ \mbox{\bf Environment} \rightarrow \mbox{\bf SymTok*}
% end::Environment_symbols[]
\newline
\newline
% tag::symbol_padding[]
\mbox{\it symbol\_padding\/}(\mbox{\it n\/}) ~\equiv~ $\`$ \mbox{\bf I} \rightarrow \mbox{\bf SymTok*}\newline
\:\: \setandincrindent
 \setandincrindent
\:\mbox{\bf{if}}\:\mbox{\it n\/} = 0\newline
\:\mbox{\bf{then}}\:\langle\rangle\newline
\:\mbox{\bf{else}}\:\langle \mbox{\it{in}\small $\mbox{\bf SymTok}$}(\mbox{\it SYM0\/})\rangle \S\mbox{\it symbol\_padding\/}(\mbox{\it n\/} - 1)\newline
\:\mbox{\bf{endif}}\: \decrindent
 \decrindent
% end::symbol_padding[]
\newline
\newline
% tag::adjust_length[]
\mbox{\it adjust\_length\/}(\mbox{\it s\/}^{\ast}, \mbox{\it n\/}) ~\equiv~ $\`$ \mbox{\bf SymTok*} \times \mbox{\bf I} \rightarrow \mbox{\bf SymTok*}\newline
\:\: \setandincrindent
 \setandincrindent
\:\mbox{\bf{if}}\:\mbox{\it n\/} < \#\mbox{\it s\/}^{\ast}\newline
\:\mbox{\bf{then}}\:\mbox{\it seq\_truncate\/}(\mbox{\it s\/}^{\ast}, \mbox{\it n\/})\newline
\:\mbox{\bf{else}}\:\mbox{\it s\/}^{\ast}\S\mbox{\it symbol\_padding\/}(\mbox{\it n\/} - \#\mbox{\it s\/}^{\ast})\newline
\:\mbox{\bf{endif}}\: \decrindent
 \decrindent
% end::adjust_length[]
\newline
\newline
% tag::normalize_name[]
{\cal N}_{\mbox{\scriptsize\tt name}}(\mbox{\it v\/}) ~\equiv~ $\`$ \mbox{\bf Value?} \rightarrow \mbox{\bf Unicode}\newline
\:\: \setandincrindent
 \setandincrindent
\:\mbox{\bf{if}}\:\mbox{\it v\/}\mbox{\ooalign{?\cr\hss!\kern .025em\hss}}\newline
\:\mbox{\bf{then}}\: \setandincrindent
\:\mbox{\bf{let}}\:\mbox{\it c\/} = \mbox{\it v\/}\mbox{!}\!\downarrow_{\mbox{\scriptsize content}}\newline
\:\mbox{\bf{in}}\: \setandincrindent
\:\mbox{\bf{if}}\:\mbox{\it c\/}\in \mbox{\bf String}\ \wedge\ \mbox{\it c\/}\notin \mbox{\bf DotNull}\newline
\:\mbox{\bf{then}}\:\mbox{\it c\/}\mid_{\mbox{\scriptsize $\mbox{\bf String}$}}\mid_{\mbox{\scriptsize $\mbox{\bf Unicode}$}}\newline
\:\mbox{\bf{else}}\:\mbox{\rm ``{\tt }''}\newline
\:\mbox{\bf{endif}}\: \decrindent
 \decrindent
\newline
\:\mbox{\bf{else}}\:\mbox{\rm ``{\tt }''}\newline
\:\mbox{\bf{endif}}\: \decrindent
 \decrindent
% end::normalize_name[]
\newline
\newline
% tag::normalize_version[]
{\cal N}_{\mbox{\scriptsize\tt version}}(\mbox{\it v\/}) ~\equiv~ $\`$ \mbox{\bf Value?} \rightarrow \mbox{\bf I}\newline
\:\: \setandincrindent
 \setandincrindent
\:\mbox{\bf{if}}\:\mbox{\it v\/}\mbox{\ooalign{?\cr\hss!\kern .025em\hss}}\newline
\:\mbox{\bf{then}}\: \setandincrindent
\:\mbox{\bf{let}}\:\mbox{\it c\/} = \mbox{\it v\/}\mbox{!}\!\downarrow_{\mbox{\scriptsize content}}\newline
\:\mbox{\bf{in}}\: \setandincrindent
\:\mbox{\bf{if}}\:\mbox{\it c\/}\in \mbox{\bf Int}\ \wedge\ \mbox{\it c\/}\notin \mbox{\bf DotNull}\newline
\:\mbox{\bf{then}}\: \setandincrindent
\:\mbox{\bf{let}}\:\mbox{\it i\/} = \mbox{\it c\/}\mid_{\mbox{\scriptsize $\mbox{\bf Int}$}}\mid_{\mbox{\scriptsize $\mbox{\bf I}$}}\newline
\:\mbox{\bf{in}}\: \setandincrindent
\:\mbox{\bf{if}}\:\mbox{\it i\/} < 1\newline
\:\mbox{\bf{then}}\:1\newline
\:\mbox{\bf{else}}\:\mbox{\it i\/}\newline
\:\mbox{\bf{endif}}\: \decrindent
 \decrindent
\newline
\:\mbox{\bf{else}}\:1\newline
\:\mbox{\bf{endif}}\: \decrindent
 \decrindent
\newline
\:\mbox{\bf{else}}\:1\newline
\:\mbox{\bf{endif}}\: \decrindent
 \decrindent
% end::normalize_version[]
\newline
\newline
% tag::normalize_max_id[]
{\cal N}_{\mbox{\scriptsize\tt max\_id}}(\mbox{\it v\/}) ~\equiv~ $\`$ \mbox{\bf Value?} \rightarrow \mbox{\bf I?}\newline
\:\: \setandincrindent
 \setandincrindent
\:\mbox{\bf{if}}\:\mbox{\it v\/}\mbox{\ooalign{?\cr\hss!\kern .025em\hss}}\newline
\:\mbox{\bf{then}}\: \setandincrindent
\:\mbox{\bf{let}}\:\mbox{\it c\/} = \mbox{\it v\/}\mbox{!}\!\downarrow_{\mbox{\scriptsize content}}\newline
\:\mbox{\bf{in}}\: \setandincrindent
\:\mbox{\bf{if}}\:\mbox{\it c\/}\in \mbox{\bf Int}\ \wedge\ \mbox{\it c\/}\notin \mbox{\bf DotNull}\newline
\:\mbox{\bf{then}}\: \setandincrindent
\:\mbox{\bf{let}}\:\mbox{\it n\/} = \mbox{\it c\/}\mid_{\mbox{\scriptsize $\mbox{\bf Int}$}}\mid_{\mbox{\scriptsize $\mbox{\bf I}$}}\newline
\:\mbox{\bf{in}}\: \setandincrindent
\:\mbox{\bf{if}}\:\mbox{\it n\/} < 0\newline
\:\mbox{\bf{then}}\:\langle \rangle \newline
\:\mbox{\bf{else}}\:\langle \mbox{\it n\/}\rangle \newline
\:\mbox{\bf{endif}}\: \decrindent
 \decrindent
\newline
\:\mbox{\bf{else}}\:\langle \rangle \newline
\:\mbox{\bf{endif}}\: \decrindent
 \decrindent
\newline
\:\mbox{\bf{else}}\:\langle \rangle \newline
\:\mbox{\bf{endif}}\: \decrindent
 \decrindent
% end::normalize_max_id[]
\newline
\newline
% tag::compile_import[]
{\cal C}_{\mbox{\scriptsize import}}(\mbox{\it s\/}, \rho) ~\equiv~ $\`$ \mbox{\bf Struct} \times \mbox{\bf Environment} \rightarrow \mbox{\bf SymTok*}\newline
\:\: \setandincrindent
 \setandincrindent
\:\mbox{\bf{let}}\:\mbox{\it n\/} = {\cal N}_{\mbox{\scriptsize\tt name}}(\mbox{\it s\/} \odot \mbox{\rm ``{\tt name}''})\newline
\:\mbox{\bf{and}}\:\mbox{\it v\/} = {\cal N}_{\mbox{\scriptsize\tt version}}(\mbox{\it s\/} \odot \mbox{\rm ``{\tt version}''})\newline
\:\mbox{\bf{and}}\:\mbox{\it m\/} = {\cal N}_{\mbox{\scriptsize\tt max\_id}}(\mbox{\it s\/} \odot \mbox{\rm ``{\tt max\_id}''})\newline
\:\mbox{\bf{in}}\: \setandincrindent
\:\mbox{\bf{if}}\:\mbox{\it n\/} = \mbox{\rm ``{\tt }''}\ \vee\ \mbox{\it n\/} = \mbox{\rm ``{\tt \$ion}''}\newline
\:\mbox{\bf{then}}\:\langle\rangle\newline
\:\mbox{\bf{else}}\: \setandincrindent
\:\mbox{\bf{let}}\:\mbox{\it s\/} = \mbox{\it best\_match}(\rho\!\downarrow_{\mbox{\scriptsize catalog}}, \mbox{\it n\/}, \mbox{\it v\/})\newline
\:\mbox{\bf{in}}\: \setandincrindent
\:\mbox{\bf{if}}\:\mbox{\it m\/}\mbox{\ooalign{?\cr\hss!\kern .025em\hss}}\newline
\:\mbox{\bf{then}}\: \setandincrindent
\:\mbox{\bf{let}}\:\mbox{\it t\/}^{\ast} =  \setandincrindent
\:\mbox{\bf{if}}\:\mbox{\it s\/}\mbox{\ooalign{?\cr\hss!\kern .025em\hss}}\newline
\:\mbox{\bf{then}}\:\mbox{\it s\/}\mbox{!}\!\downarrow_{\mbox{\scriptsize symbols}}\newline
\:\mbox{\bf{else}}\:\langle \rangle \newline
\:\mbox{\bf{endif}}\: \decrindent
\newline
\:\mbox{\bf{in}}\:\mbox{\it adjust\_length\/}(\mbox{\it t\/}^{\ast}, \mbox{\it m\/}\mbox{!}) \decrindent
\newline
\:\mbox{\bf{else}}\: \setandincrindent
\:\mbox{\bf{if}}\:\mbox{\it s\/}\mbox{\ooalign{?\cr\hss!\kern .025em\hss}}\ \wedge\ \mbox{\it s\/}\mbox{!}\!\downarrow_{\mbox{\scriptsize version}} = \mbox{\it v\/}\newline
\:\mbox{\bf{then}}\:\mbox{\it s\/}\mbox{!}\!\downarrow_{\mbox{\scriptsize symbols}}\newline
\:\mbox{\bf{else}}\:\mbox{\it wrong\/}(\mbox{\rm ``{\tt No exact-match for }''}, \mbox{\it n\/}, \mbox{\rm ``{\tt @}''}, \mbox{\it v\/})\newline
\:\mbox{\bf{endif}}\: \decrindent
\newline
\:\mbox{\bf{endif}}\: \decrindent
 \decrindent
\newline
\:\mbox{\bf{endif}}\: \decrindent
 \decrindent
 \decrindent
% end::compile_import[]
\newline
\newline
% tag::compile_imports[]
{\cal C}_{\mbox{\scriptsize import}}^{\ast}(\mbox{\it v\/}^{\ast}, \rho) ~\equiv~ $\`$ \mbox{\bf Value*} \times \mbox{\bf Environment} \rightarrow \mbox{\bf SymTok*}\newline
\:\: \setandincrindent
 \setandincrindent
\:\mbox{\bf{if}}\:\#\mbox{\it v\/}^{\ast}=0\newline
\:\mbox{\bf{then}}\:\langle\rangle\newline
\:\mbox{\bf{else}}\: \setandincrindent
\:\mbox{\bf{let}}\:\mbox{\it c\/} = \mbox{\it v\/}^{\ast}\!\downarrow_{0}\!\downarrow_{\mbox{\scriptsize content}}\newline
\:\mbox{\bf{in}}\: \setandincrindent
\:\mbox{\bf{let}}\:\mbox{\it t\/}^{\ast} =  \setandincrindent
\:\mbox{\bf{if}}\:\mbox{\it c\/}\in \mbox{\bf Struct}\ \wedge\ \mbox{\it c\/}\notin \mbox{\bf DotNull}\newline
\:\mbox{\bf{then}}\:{\cal C}_{\mbox{\scriptsize import}}(\mbox{\it c\/}\mid_{\mbox{\scriptsize $\mbox{\bf Struct}$}}, \rho)\newline
\:\mbox{\bf{else}}\:\langle\rangle\newline
\:\mbox{\bf{endif}}\: \decrindent
\newline
\:\mbox{\bf{in}}\:\mbox{\it t\/}^{\ast}\S{\cal C}_{\mbox{\scriptsize import}}^{\ast}(\mbox{\it v\/}^{\ast}\dagger1, \rho) \decrindent
 \decrindent
\newline
\:\mbox{\bf{endif}}\: \decrindent
 \decrindent
% end::compile_imports[]
\newline
\newline
% tag::imported_symbols[]
{\cal C}_{\mbox{\scriptsize\tt imports}}(\mbox{\it v\/}, \rho) ~\equiv~ $\`$ \mbox{\bf Value?} \times \mbox{\bf Environment} \rightarrow \mbox{\bf SymTok*}\newline
\:\: \setandincrindent
 \setandincrindent
\:\mbox{\bf{let}}\:\mbox{\it t\/}^{\ast} = \mbox{\it SymToks\_for\_IVM\/}(\rho\!\downarrow_{\mbox{\scriptsize IVM}})\newline
\:\mbox{\bf{in}}\: \setandincrindent
\:\mbox{\bf{if}}\:\mbox{\it v\/}\mbox{\ooalign{?\cr\hss!\kern .025em\hss}}\newline
\:\mbox{\bf{then}}\: \setandincrindent
\:\mbox{\bf{if}}\:\mbox{\it v\/}\mbox{!} \cong \mbox{\rm ``{\tt \$ion\_symbol\_table}''}\newline
\:\mbox{\bf{then}}\:\rho\!\downarrow_{\mbox{\scriptsize symbols}}\newline
\:\mbox{\bf{else}}\: \setandincrindent
\:\mbox{\bf{let}}\:\mbox{\it c\/} = \mbox{\it v\/}\mbox{!}\!\downarrow_{\mbox{\scriptsize content}}\newline
\:\mbox{\bf{in}}\: \setandincrindent
\:\mbox{\bf{if}}\:\mbox{\it c\/}\in \mbox{\bf List}\ \wedge\ \mbox{\it c\/}\notin \mbox{\bf DotNull}\newline
\:\mbox{\bf{then}}\:\mbox{\it t\/}^{\ast}\S{\cal C}_{\mbox{\scriptsize import}}^{\ast}(\mbox{\it c\/}\mid_{\mbox{\scriptsize $\mbox{\bf List}$}}\mid_{\mbox{\scriptsize $\mbox{\bf Value*}$}}, \rho)\newline
\:\mbox{\bf{else}}\:\mbox{\it t\/}^{\ast}\newline
\:\mbox{\bf{endif}}\: \decrindent
 \decrindent
\newline
\:\mbox{\bf{endif}}\: \decrindent
\newline
\:\mbox{\bf{else}}\:\mbox{\it t\/}^{\ast}\newline
\:\mbox{\bf{endif}}\: \decrindent
 \decrindent
 \decrindent
% end::imported_symbols[]
\newline
\newline
% tag::compile_symbols[]
{\cal C}_{\mbox{\scriptsize symbol}}^{\ast}(\mbox{\it v\/}^{\ast}) ~\equiv~ $\`$ \mbox{\bf Value*} \rightarrow \mbox{\bf SymTok*}\newline
\:\: \setandincrindent
 \setandincrindent
\:\mbox{\bf{if}}\:\#\mbox{\it v\/}^{\ast}=0\newline
\:\mbox{\bf{then}}\:\langle\rangle\newline
\:\mbox{\bf{else}}\: \setandincrindent
\:\mbox{\bf{let}}\:\mbox{\it c\/} = \mbox{\it v\/}^{\ast}\!\downarrow_{0}\!\downarrow_{\mbox{\scriptsize content}}\newline
\:\mbox{\bf{in}}\: \setandincrindent
\:\mbox{\bf{let}}\:\mbox{\it t\/} =  \setandincrindent
\:\mbox{\bf{if}}\:\mbox{\it c\/}\in \mbox{\bf String}\ \wedge\ \mbox{\it c\/}\notin \mbox{\bf DotNull}\newline
\:\mbox{\bf{then}}\:\mbox{\it{in}\small $\mbox{\bf SymTok}$}(\mbox{\it c\/}\mid_{\mbox{\scriptsize $\mbox{\bf String}$}}\mid_{\mbox{\scriptsize $\mbox{\bf Unicode}$}})\newline
\:\mbox{\bf{else}}\:\mbox{\it{in}\small $\mbox{\bf SymTok}$}(\mbox{\it SYM0\/})\newline
\:\mbox{\bf{endif}}\: \decrindent
\newline
\:\mbox{\bf{in}}\:\langle \mbox{\it t\/}\rangle \S{\cal C}_{\mbox{\scriptsize symbol}}^{\ast}(\mbox{\it v\/}^{\ast}\dagger1) \decrindent
 \decrindent
\newline
\:\mbox{\bf{endif}}\: \decrindent
 \decrindent
% end::compile_symbols[]
\newline
\newline
% tag::declared_symbols[]
{\cal C}_{\mbox{\scriptsize\tt symbols}}(\mbox{\it v\/}) ~\equiv~ $\`$ \mbox{\bf Value?} \rightarrow \mbox{\bf SymTok*}\newline
\:\: \setandincrindent
 \setandincrindent
\:\mbox{\bf{if}}\:\mbox{\it v\/}\mbox{\ooalign{?\cr\hss!\kern .025em\hss}}\newline
\:\mbox{\bf{then}}\: \setandincrindent
\:\mbox{\bf{let}}\:\mbox{\it c\/} = \mbox{\it v\/}\mbox{!}\!\downarrow_{\mbox{\scriptsize content}}\newline
\:\mbox{\bf{in}}\: \setandincrindent
\:\mbox{\bf{if}}\:\mbox{\it c\/}\in \mbox{\bf List}\ \wedge\ \mbox{\it c\/}\notin \mbox{\bf DotNull}\newline
\:\mbox{\bf{then}}\:{\cal C}_{\mbox{\scriptsize symbol}}^{\ast}(\mbox{\it c\/}\mid_{\mbox{\scriptsize $\mbox{\bf List}$}}\mid_{\mbox{\scriptsize $\mbox{\bf Value*}$}})\newline
\:\mbox{\bf{else}}\:\langle\rangle\newline
\:\mbox{\bf{endif}}\: \decrindent
 \decrindent
\newline
\:\mbox{\bf{else}}\:\langle\rangle\newline
\:\mbox{\bf{endif}}\: \decrindent
 \decrindent
% end::declared_symbols[]
\newline
\newline
% tag::SymToks_for_LST[]
{\cal C}_{\mbox{\scriptsize LST}}(\mbox{\it s\/}, \rho) ~\equiv~ $\`$ \mbox{\bf Struct} \times \mbox{\bf Environment} \rightarrow \mbox{\bf SymTok*}\newline
\:\: \setandincrindent
 \setandincrindent
\:\mbox{\bf{if}}\:\mbox{\it s\/}\in \mbox{\bf DotNull}\newline
\:\mbox{\bf{then}}\:{\cal C}_{\mbox{\scriptsize LST}}(\mbox{\it{in}\small $\mbox{\bf Struct}$}(\langle \rangle ), \rho)\newline
\:\mbox{\bf{else}}\:{\cal C}_{\mbox{\scriptsize\tt imports}}(\mbox{\it s\/} \odot \mbox{\rm ``{\tt imports}''}, \rho)\S{\cal C}_{\mbox{\scriptsize\tt symbols}}(\mbox{\it s\/} \odot \mbox{\rm ``{\tt symbols}''})\newline
\:\mbox{\bf{endif}}\: \decrindent
 \decrindent
% end::SymToks_for_LST[]
\newline
\newline
% tag::Environment_after_IVM[]
\mbox{\it Environment\_after\_IVM\/}(\mbox{\it i\/}, \rho) ~\equiv~ $\`$ \mbox{\bf IVM} \times \mbox{\bf Environment} \rightarrow \mbox{\bf Environment}\newline
\:\: \setandincrindent
\mbox{\it{in}\small $\mbox{\bf Environment}$}(\langle \rho\!\downarrow_{\mbox{\scriptsize catalog}}, \mbox{\it i\/}, \mbox{\it SymToks\_for\_IVM\/}(\mbox{\it i\/})\rangle ) \decrindent
% end::Environment_after_IVM[]
\newline
\newline
% tag::Environment_after_LST[]
\mbox{\it Environment\_after\_LST\/}(\mbox{\it s\/}, \rho) ~\equiv~ $\`$ \mbox{\bf Struct} \times \mbox{\bf Environment} \rightarrow \mbox{\bf Environment}\newline
\:\: \setandincrindent
\mbox{\it{in}\small $\mbox{\bf Environment}$}(\langle \rho\!\downarrow_{\mbox{\scriptsize catalog}}, \rho\!\downarrow_{\mbox{\scriptsize IVM}}, {\cal C}_{\mbox{\scriptsize LST}}(\mbox{\it s\/}, \rho)\rangle ) \decrindent
% end::Environment_after_LST[]
\newline
\newline
% tag::expand_STree[]
{\cal X}_{\mbox{\scriptsize\bf STree}}(\mbox{\it t\/}, \rho) ~\equiv~ $\`$ \mbox{\bf STree} \times \mbox{\bf Environment} \rightarrow \mbox{\bf Value*}\newline
\:\: \setandincrindent
\langle {\cal X}_{\mbox{\scriptsize\bf SValue}}(\mbox{\it t\/}\mid_{\mbox{\scriptsize $\mbox{\bf SValue}$}}, \rho)\rangle  \decrindent
% end::expand_STree[]
\newline
\newline
% tag::expand_STree*[]
{\cal X}_{\mbox{\scriptsize\bf STree}}^{\ast}(\mbox{\it t\/}^{\ast}, \rho) ~\equiv~ $\`$ \mbox{\bf STree*} \times \mbox{\bf Environment} \rightarrow \mbox{\bf Value*}\newline
\:\: \setandincrindent
 \setandincrindent
\:\mbox{\bf{if}}\:\#\mbox{\it t\/}^{\ast}=0\newline
\:\mbox{\bf{then}}\:\langle \rangle \newline
\:\mbox{\bf{else}}\:{\cal X}_{\mbox{\scriptsize\bf STree}}(\mbox{\it t\/}^{\ast}\!\downarrow_{0}, \rho)\S{\cal X}_{\mbox{\scriptsize\bf STree}}^{\ast}(\mbox{\it t\/}^{\ast}\dagger1, \rho)\newline
\:\mbox{\bf{endif}}\: \decrindent
 \decrindent
% end::expand_STree*[]
\newline
\newline
% tag::expand_SValue[]
{\cal X}_{\mbox{\scriptsize\bf SValue}}(\mbox{\it sv\/}, \rho) ~\equiv~ $\`$ \mbox{\bf SValue} \times \mbox{\bf Environment} \rightarrow \mbox{\bf Value}\newline
\:\: \setandincrindent
\mbox{\it{in}\small $\mbox{\bf Value}$}(\langle {\cal X}_{\mbox{\scriptsize\bf SSymTok}}^{\ast}(\mbox{\it sv\/}\!\downarrow_{\mbox{\scriptsize annots}}, \rho), {\cal X}_{\mbox{\scriptsize\bf SContent}}(\mbox{\it sv\/}\!\downarrow_{\mbox{\scriptsize content}}, \rho)\rangle ) \decrindent
% end::expand_SValue[]
\newline
\newline
% tag::expand_SContent[]
{\cal X}_{\mbox{\scriptsize\bf SContent}}(\mbox{\it sv\/}, \rho) ~\equiv~ $\`$ \mbox{\bf SContent} \times \mbox{\bf Environment} \rightarrow \mbox{\bf Content}\newline
\:\: \setandincrindent
 \setandincrindent
\:\mbox{\bf{if}}\:\mbox{\it sv\/}\in \mbox{\bf SSymbol}\newline
\:\mbox{\bf{then}}\:\mbox{\it{in}\small $\mbox{\bf Content}$}({\cal X}_{\mbox{\scriptsize\bf SSymbol}}(\mbox{\it sv\/}\mid_{\mbox{\scriptsize $\mbox{\bf SSymbol}$}}, \rho))\newline
\:\mbox{\bf{else}}\: \setandincrindent
\:\mbox{\bf{if}}\:\mbox{\it sv\/}\in \mbox{\bf SList}\newline
\:\mbox{\bf{then}}\:\mbox{\it{in}\small $\mbox{\bf Content}$}({\cal X}_{\mbox{\scriptsize\bf SList}}(\mbox{\it sv\/}\mid_{\mbox{\scriptsize $\mbox{\bf SList}$}}, \rho))\newline
\:\mbox{\bf{else}}\: \setandincrindent
\:\mbox{\bf{if}}\:\mbox{\it sv\/}\in \mbox{\bf SSexp}\newline
\:\mbox{\bf{then}}\:\mbox{\it{in}\small $\mbox{\bf Content}$}({\cal X}_{\mbox{\scriptsize\bf SSexp}}(\mbox{\it sv\/}\mid_{\mbox{\scriptsize $\mbox{\bf SSexp}$}}, \rho))\newline
\:\mbox{\bf{else}}\: \setandincrindent
\:\mbox{\bf{if}}\:\mbox{\it sv\/}\in \mbox{\bf SStruct}\newline
\:\mbox{\bf{then}}\:\mbox{\it{in}\small $\mbox{\bf Content}$}({\cal X}_{\mbox{\scriptsize\bf SStruct}}(\mbox{\it sv\/}\mid_{\mbox{\scriptsize $\mbox{\bf SStruct}$}}, \rho))\newline
\:\mbox{\bf{else}}\: \setandincrindent
\:\mbox{\bf{if}}\:\mbox{\it sv\/}\in \mbox{\bf NullNull}\newline
\:\mbox{\bf{then}}\:\mbox{\it{in}\small $\mbox{\bf Content}$}(\mbox{\it sv\/}\mid_{\mbox{\scriptsize $\mbox{\bf NullNull}$}})\newline
\:\mbox{\bf{else}}\: \setandincrindent
\:\mbox{\bf{if}}\:\mbox{\it sv\/}\in \mbox{\bf Bool}\newline
\:\mbox{\bf{then}}\:\mbox{\it{in}\small $\mbox{\bf Content}$}(\mbox{\it sv\/}\mid_{\mbox{\scriptsize $\mbox{\bf Bool}$}})\newline
\:\mbox{\bf{else}}\: \setandincrindent
\:\mbox{\bf{if}}\:\mbox{\it sv\/}\in \mbox{\bf Int}\newline
\:\mbox{\bf{then}}\:\mbox{\it{in}\small $\mbox{\bf Content}$}(\mbox{\it sv\/}\mid_{\mbox{\scriptsize $\mbox{\bf Int}$}})\newline
\:\mbox{\bf{else}}\: \setandincrindent
\:\mbox{\bf{if}}\:\mbox{\it sv\/}\in \mbox{\bf String}\newline
\:\mbox{\bf{then}}\:\mbox{\it{in}\small $\mbox{\bf Content}$}(\mbox{\it sv\/}\mid_{\mbox{\scriptsize $\mbox{\bf String}$}})\newline
\:\mbox{\bf{else}}\:\mbox{\it wrong\/}(\mbox{\rm ``{\tt should not happen}''})\newline
\:\mbox{\bf{endif}}\: \decrindent
\newline
\:\mbox{\bf{endif}}\: \decrindent
\newline
\:\mbox{\bf{endif}}\: \decrindent
\newline
\:\mbox{\bf{endif}}\: \decrindent
\newline
\:\mbox{\bf{endif}}\: \decrindent
\newline
\:\mbox{\bf{endif}}\: \decrindent
\newline
\:\mbox{\bf{endif}}\: \decrindent
\newline
\:\mbox{\bf{endif}}\: \decrindent
 \decrindent
% end::expand_SContent[]
\newline
\newline
% tag::expand_SSymTok[]
{\cal X}_{\mbox{\scriptsize\bf SSymTok}}(\mbox{\it s\/}, \rho) ~\equiv~ $\`$ \mbox{\bf SSymTok} \times \mbox{\bf Environment} \rightarrow \mbox{\bf SymTok}\newline
\:\: \setandincrindent
 \setandincrindent
\:\mbox{\bf{if}}\:\mbox{\it s\/}\in \mbox{\bf Unicode}\newline
\:\mbox{\bf{then}}\:\mbox{\it{in}\small $\mbox{\bf SymTok}$}(\mbox{\it s\/}\mid_{\mbox{\scriptsize $\mbox{\bf Unicode}$}})\newline
\:\mbox{\bf{else}}\: \setandincrindent
\:\mbox{\bf{let}}\:\mbox{\it i\/} = \mbox{\it s\/}\mid_{\mbox{\scriptsize $\mbox{\bf I}$}}\newline
\:\mbox{\bf{and}}\:\mbox{\it t\/}^{\ast} = \rho\!\downarrow_{\mbox{\scriptsize symbols}}\newline
\:\mbox{\bf{in}}\: \setandincrindent
\:\mbox{\bf{if}}\:\mbox{\it i\/} < \#\mbox{\it t\/}^{\ast}\newline
\:\mbox{\bf{then}}\:\mbox{\it t\/}^{\ast}\!\downarrow_{\mbox{\it i\/}}\newline
\:\mbox{\bf{else}}\:\mbox{\it wrong\/}(\mbox{\rm ``{\tt Invalid symbol address }''}, \mbox{\it i\/})\newline
\:\mbox{\bf{endif}}\: \decrindent
 \decrindent
\newline
\:\mbox{\bf{endif}}\: \decrindent
 \decrindent
% end::expand_SSymTok[]
\newline
\newline
% tag::expand_SSymTok*[]
{\cal X}_{\mbox{\scriptsize\bf SSymTok}}^{\ast}(\mbox{\it s\/}^{\ast}, \rho) ~\equiv~ $\`$ \mbox{\bf SSymTok*} \times \mbox{\bf Environment} \rightarrow \mbox{\bf SymTok*}\newline
\:\: \setandincrindent
 \setandincrindent
\:\mbox{\bf{if}}\:\#\mbox{\it s\/}^{\ast}=0\newline
\:\mbox{\bf{then}}\:\langle\rangle\newline
\:\mbox{\bf{else}}\:\langle {\cal X}_{\mbox{\scriptsize\bf SSymTok}}(\mbox{\it s\/}^{\ast}\!\downarrow_{0}, \rho)\rangle \S{\cal X}_{\mbox{\scriptsize\bf SSymTok}}^{\ast}(\mbox{\it s\/}^{\ast}\dagger1, \rho)\newline
\:\mbox{\bf{endif}}\: \decrindent
 \decrindent
% end::expand_SSymTok*[]
\newline
\newline
% tag::expand_SSymbol[]
{\cal X}_{\mbox{\scriptsize\bf SSymbol}}(\mbox{\it v\/}, \rho) ~\equiv~ $\`$ \mbox{\bf SSymbol} \times \mbox{\bf Environment} \rightarrow \mbox{\bf Symbol}\newline
\:\: \setandincrindent
 \setandincrindent
\:\mbox{\bf{if}}\:\mbox{\it v\/}\in \mbox{\bf DotNull}\newline
\:\mbox{\bf{then}}\:\mbox{\it{in}\small $\mbox{\bf Symbol}$}(\mbox{\it DOTNULL\/})\newline
\:\mbox{\bf{else}}\:\mbox{\it{in}\small $\mbox{\bf Symbol}$}({\cal X}_{\mbox{\scriptsize\bf SSymTok}}(\mbox{\it v\/}\mid_{\mbox{\scriptsize $\mbox{\bf SSymTok}$}}, \rho))\newline
\:\mbox{\bf{endif}}\: \decrindent
 \decrindent
% end::expand_SSymbol[]
\newline
\newline
% tag::expand_SList[]
{\cal X}_{\mbox{\scriptsize\bf SList}}(\mbox{\it v\/}, \rho) ~\equiv~ $\`$ \mbox{\bf SList} \times \mbox{\bf Environment} \rightarrow \mbox{\bf List}\newline
\:\: \setandincrindent
 \setandincrindent
\:\mbox{\bf{if}}\:\mbox{\it v\/}\in \mbox{\bf DotNull}\newline
\:\mbox{\bf{then}}\:\mbox{\it{in}\small $\mbox{\bf List}$}(\mbox{\it DOTNULL\/})\newline
\:\mbox{\bf{else}}\:\mbox{\it{in}\small $\mbox{\bf List}$}({\cal X}_{\mbox{\scriptsize\bf STree}}^{\ast}(\mbox{\it v\/}\mid_{\mbox{\scriptsize $\mbox{\bf STree*}$}}, \rho))\newline
\:\mbox{\bf{endif}}\: \decrindent
 \decrindent
% end::expand_SList[]
\newline
\newline
% tag::expand_SSexp[]
{\cal X}_{\mbox{\scriptsize\bf SSexp}}(\mbox{\it v\/}, \rho) ~\equiv~ $\`$ \mbox{\bf SSexp} \times \mbox{\bf Environment} \rightarrow \mbox{\bf Sexp}\newline
\:\: \setandincrindent
 \setandincrindent
\:\mbox{\bf{if}}\:\mbox{\it v\/}\in \mbox{\bf DotNull}\newline
\:\mbox{\bf{then}}\:\mbox{\it{in}\small $\mbox{\bf Sexp}$}(\mbox{\it DOTNULL\/})\newline
\:\mbox{\bf{else}}\:\mbox{\it{in}\small $\mbox{\bf Sexp}$}({\cal X}_{\mbox{\scriptsize\bf STree}}^{\ast}(\mbox{\it v\/}\mid_{\mbox{\scriptsize $\mbox{\bf STree*}$}}, \rho))\newline
\:\mbox{\bf{endif}}\: \decrindent
 \decrindent
% end::expand_SSexp[]
\newline
\newline
% tag::expand_SField[]
{\cal X}_{\mbox{\scriptsize\bf SField}}(\mbox{\it sf\/}, \rho) ~\equiv~ $\`$ \mbox{\bf SField} \times \mbox{\bf Environment} \rightarrow \mbox{\bf Field*}\newline
\:\: \setandincrindent
 \setandincrindent
\:\mbox{\bf{let}}\:\mbox{\it t\/} = {\cal X}_{\mbox{\scriptsize\bf SSymTok}}(\mbox{\it sf\/}\!\downarrow_{\mbox{\scriptsize name}}, \rho)\newline
\:\mbox{\bf{and}}\:\mbox{\it v\/}^{\ast} = {\cal X}_{\mbox{\scriptsize\bf STree}}(\mbox{\it sf\/}\!\downarrow_{\mbox{\scriptsize tree}}, \rho)\newline
\:\mbox{\bf{in}}\: \setandincrindent
\:\mbox{\bf{letrec}}\:\mbox{\it mk\_fields\/} = \lambda \mbox{\it v\/}^{\ast}_{1}. \setandincrindent
\:\mbox{\bf{if}}\:\#\mbox{\it v\/}^{\ast}_{1}=0\newline
\:\mbox{\bf{then}}\:\langle \rangle \newline
\:\mbox{\bf{else}}\:\langle \mbox{\it{in}\small $\mbox{\bf Field}$}(\langle \mbox{\it t\/}, \mbox{\it v\/}^{\ast}_{1}\!\downarrow_{0}\rangle )\rangle \S\mbox{\it mk\_fields\/}(\mbox{\it v\/}^{\ast}_{1}\dagger1)\newline
\:\mbox{\bf{endif}}\: \decrindent
\newline
\:\mbox{\bf{in}}\:\mbox{\it mk\_fields\/}(\mbox{\it v\/}^{\ast}) \decrindent
 \decrindent
 \decrindent
% end::expand_SField[]
\newline
\newline
% tag::expand_SField*[]
{\cal X}_{\mbox{\scriptsize\bf SField}}^{\ast}(\mbox{\it sf\/}^{\ast}, \rho) ~\equiv~ $\`$ \mbox{\bf SField*} \times \mbox{\bf Environment} \rightarrow \mbox{\bf Field*}\newline
\:\: \setandincrindent
 \setandincrindent
\:\mbox{\bf{if}}\:\#\mbox{\it sf\/}^{\ast}=0\newline
\:\mbox{\bf{then}}\:\langle \rangle \newline
\:\mbox{\bf{else}}\:{\cal X}_{\mbox{\scriptsize\bf SField}}(\mbox{\it sf\/}^{\ast}\!\downarrow_{0}, \rho)\S{\cal X}_{\mbox{\scriptsize\bf SField}}^{\ast}(\mbox{\it sf\/}^{\ast}\dagger1, \rho)\newline
\:\mbox{\bf{endif}}\: \decrindent
 \decrindent
% end::expand_SField*[]
\newline
\newline
% tag::expand_SStruct[]
{\cal X}_{\mbox{\scriptsize\bf SStruct}}(\mbox{\it v\/}, \rho) ~\equiv~ $\`$ \mbox{\bf SStruct} \times \mbox{\bf Environment} \rightarrow \mbox{\bf Struct}\newline
\:\: \setandincrindent
 \setandincrindent
\:\mbox{\bf{if}}\:\mbox{\it v\/}\in \mbox{\bf DotNull}\newline
\:\mbox{\bf{then}}\:\mbox{\it{in}\small $\mbox{\bf Struct}$}(\mbox{\it DOTNULL\/})\newline
\:\mbox{\bf{else}}\:\mbox{\it{in}\small $\mbox{\bf Struct}$}({\cal X}_{\mbox{\scriptsize\bf SField}}^{\ast}(\mbox{\it v\/}\mid_{\mbox{\scriptsize $\mbox{\bf SField*}$}}, \rho))\newline
\:\mbox{\bf{endif}}\: \decrindent
 \decrindent
% end::expand_SStruct[]
\newline
\newline
% tag::TE_Value[]
\overline{\cal E}_{\mbox{\scriptsize\bf Value}}(\mbox{\it v\/}, \rho, \kappa) ~\equiv~ $\`$ \mbox{\bf Value} \times \mbox{\bf Environment} \times \mbox{\bf TContinuation} \rightarrow \mbox{\bf Value*}\newline
\:\: \setandincrindent
 \setandincrindent
\:\mbox{\bf{if}}\:\mbox{\it v\/}\!\downarrow_{\mbox{\scriptsize content}}\in \mbox{\bf Struct}\ \wedge\ \#\mbox{\it v\/}\!\downarrow_{\mbox{\scriptsize annots}}\neq 0\ \wedge\ \mbox{\it v\/}\!\downarrow_{\mbox{\scriptsize annots}}\!\downarrow_{0} \cong \mbox{\rm ``{\tt \$ion\_symbol\_table}''}\newline
\:\mbox{\bf{then}}\:\kappa(\mbox{\it Environment\_after\_LST\/}(\mbox{\it v\/}\!\downarrow_{\mbox{\scriptsize content}}\mid_{\mbox{\scriptsize $\mbox{\bf Struct}$}}, \rho), \langle \rangle )\newline
\:\mbox{\bf{else}}\:\kappa(\rho, \langle \mbox{\it v\/}\rangle )\newline
\:\mbox{\bf{endif}}\: \decrindent
 \decrindent
% end::TE_Value[]
\newline
\newline
% tag::TE_Value*[]
\overline{\cal E}_{\mbox{\scriptsize\bf Value}}^{\ast}(\mbox{\it v\/}^{\ast}, \rho, \kappa) ~\equiv~ $\`$ \mbox{\bf Value*} \times \mbox{\bf Environment} \times \mbox{\bf TContinuation} \rightarrow \mbox{\bf Value*}\newline
\:\: \setandincrindent
 \setandincrindent
\:\mbox{\bf{if}}\:\#\mbox{\it v\/}^{\ast}=0\newline
\:\mbox{\bf{then}}\:\kappa(\rho, \mbox{\it v\/}^{\ast})\newline
\:\mbox{\bf{else}}\:\overline{\cal E}_{\mbox{\scriptsize\bf Value}}(\mbox{\it v\/}^{\ast}\!\downarrow_{0}, \rho, \lambda \rho_{1} \mbox{\it v\/}^{\ast}_{1}.\overline{\cal E}_{\mbox{\scriptsize\bf Value}}^{\ast}(\mbox{\it v\/}^{\ast}\dagger1, \rho_{1}, \lambda \rho_{2} \mbox{\it v\/}^{\ast}_{2}.\kappa(\rho_{2}, \mbox{\it v\/}^{\ast}_{1}\S\mbox{\it v\/}^{\ast}_{2})))\newline
\:\mbox{\bf{endif}}\: \decrindent
 \decrindent
% end::TE_Value*[]
\newline
\newline
% tag::TE_TSTree[]
\overline{\cal E}_{\mbox{\scriptsize\bf TSTree}}(\mbox{\it t\/}, \rho, \kappa) ~\equiv~ $\`$ \mbox{\bf TSTree} \times \mbox{\bf Environment} \times \mbox{\bf TContinuation} \rightarrow \mbox{\bf Value*}\newline
\:\: \setandincrindent
 \setandincrindent
\:\mbox{\bf{if}}\:\mbox{\it t\/}\in \mbox{\bf IVM}\newline
\:\mbox{\bf{then}}\:\kappa(\mbox{\it Environment\_after\_IVM\/}(\mbox{\it t\/}\mid_{\mbox{\scriptsize $\mbox{\bf IVM}$}}, \rho), \langle \rangle )\newline
\:\mbox{\bf{else}}\: \setandincrindent
\:\mbox{\bf{let}}\:\mbox{\it v\/}^{\ast} = {\cal X}_{\mbox{\scriptsize\bf STree}}(\mbox{\it t\/}\mid_{\mbox{\scriptsize $\mbox{\bf STree}$}}, \rho)\newline
\:\mbox{\bf{in}}\:\overline{\cal E}_{\mbox{\scriptsize\bf Value}}^{\ast}(\mbox{\it v\/}^{\ast}, \rho, \kappa) \decrindent
\newline
\:\mbox{\bf{endif}}\: \decrindent
 \decrindent
% end::TE_TSTree[]
\newline
\newline
% tag::ParseStep_tree[]
\mbox{\it p\/}\!\downarrow_{\mbox{\scriptsize tree}} ~\equiv~ \mbox{\it p\/}\!\downarrow_{0}$\`$ \mbox{\bf ParseStep} \rightarrow \mbox{\bf TSTree}
% end::ParseStep_tree[]
\newline
\newline
% tag::ParseStep_next[]
\mbox{\it p\/}\!\downarrow_{\mbox{\scriptsize next}} ~\equiv~ \mbox{\it p\/}\!\downarrow_{1}$\`$ \mbox{\bf ParseStep} \rightarrow \mbox{\bf ParseStream}
% end::ParseStep_next[]
\newline
\newline
% tag::TE_ParseStream[]
\overline{\cal E}_{\mbox{\scriptsize\bf ParseStream}}(\mbox{\it p\/}, \rho, \kappa) ~\equiv~ $\`$ \mbox{\bf ParseStream} \times \mbox{\bf Environment} \times \mbox{\bf TContinuation} \rightarrow \mbox{\bf Value*}\newline
\:\: \setandincrindent
 \setandincrindent
\:\mbox{\bf{let}}\:\mbox{\it step\/} = \mbox{\it p\/}(\rho\!\downarrow_{\mbox{\scriptsize IVM}})\newline
\:\mbox{\bf{in}}\: \setandincrindent
\:\mbox{\bf{if}}\:\mbox{\it step\/}\mbox{\ooalign{?\cr\hss!\kern .025em\hss}}\newline
\:\mbox{\bf{then}}\:\overline{\cal E}_{\mbox{\scriptsize\bf TSTree}}(\mbox{\it step\/}\mbox{!}\!\downarrow_{\mbox{\scriptsize tree}}, \rho, \lambda \rho_{1} \mbox{\it v\/}^{\ast}_{1}.\overline{\cal E}_{\mbox{\scriptsize\bf ParseStream}}(\mbox{\it step\/}\mbox{!}\!\downarrow_{\mbox{\scriptsize next}}, \rho_{1}, \lambda \rho_{2} \mbox{\it v\/}^{\ast}_{2}.\kappa(\rho_{2}, \mbox{\it v\/}^{\ast}_{1}\S\mbox{\it v\/}^{\ast}_{2})))\newline
\:\mbox{\bf{else}}\:\kappa(\rho, \langle \rangle )\newline
\:\mbox{\bf{endif}}\: \decrindent
 \decrindent
 \decrindent
% end::TE_ParseStream[]
\newline
\newline
% tag::mk_Evaluator[]
\mbox{\it mk\_Evaluator\/}(\mbox{\it p\/}) ~\equiv~ $\`$ \mbox{\bf Parser} \rightarrow \mbox{\bf Evaluator}\newline
\:\: \setandincrindent
\lambda \mbox{\it d\/} \mbox{\it c\/}. \setandincrindent
\:\mbox{\bf{let}}\:\mbox{\it p\/}_{0} = \mbox{\it p\/}(\mbox{\it d\/})\newline
\:\mbox{\bf{and}}\:\rho_{0} = \mbox{\it{in}\small $\mbox{\bf Environment}$}(\langle \mbox{\it c\/}, \mbox{\it IVM\_1\_0\/}, \mbox{\it SymToks\_for\_IVM\/}(\mbox{\it IVM\_1\_0\/})\rangle )\newline
\:\mbox{\bf{and}}\:\kappa_{0} = \lambda \rho \mbox{\it v\/}^{\ast}.\mbox{\it v\/}^{\ast}\newline
\:\mbox{\bf{in}}\:\overline{\cal E}_{\mbox{\scriptsize\bf ParseStream}}(\mbox{\it p\/}_{0}, \rho_{0}, \kappa_{0}) \decrindent
 \decrindent
% end::mk_Evaluator[]
\newline
% end::functions[]
